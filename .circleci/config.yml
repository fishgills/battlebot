version: 2.1

orbs:
  gcp-gcr: circleci/gcp-gcr@0.16.9
  nx: nrwl/nx@1.6.2

executors:
  docker-executor:
    docker:
      - image: public.ecr.aws/docker/library/node:lts-alpine
    working_directory: ~/repo

jobs:
  detect-affected:
    executor: docker-executor
    steps:
      - checkout
      - restore_cache:
          name: Restore Cached Dependencies
          keys:
            - v1-deps-{{ checksum "package-lock.json" }}
      - run:
          name: Install Dependencies
          command: npm install
      - save_cache:
          name: Save Cached Dependencies
          key: v1-deps-{{ checksum "package-lock.json" }}
          paths:
            - node_modules
      - nx/set-shas
      - run:
          name: Check Affected Projects
          command: |
            npx nx graph --affected --base=master --head=$NX_BASE --file=affected.json
      - persist_to_workspace:
          root: ~/repo
          paths:
            - affected.json

  build-and-push-backend:
    executor: docker-executor
    steps:
      - checkout
      - attach_workspace:
          at: ~/repo
      - restore_cache:
          name: Restore Cached Dependencies
          keys:
            - v1-deps-{{ checksum "package-lock.json" }}
      - run:
          name: Install Dependencies
          command: npm install
      - run:
          name: Build Backend Application
          command: |
            if grep -q '"project": "backend"' affected.json; then
              npx nx build backend
            else
              echo "Backend not affected. Skipping build."
              exit 0
            fi
      - gcp-gcr/gcr-auth
      - gcp-gcr/build-image:
          image: backend
          dockerfile: packages/backend/Dockerfile
          extra_build_args: --build-arg SHA1=$CIRCLE_SHA1 --build-arg APP=backend
          tag: $CIRCLE_SHA1
      - gcp-gcr/push-image:
          image: backend
          tag: $CIRCLE_SHA1
      - gcp-gcr/tag-image:
          image: backend
          source-tag: $CIRCLE_SHA1
          target-tag: latest

  build-and-push-bot:
    executor: docker-executor
    steps:
      - checkout
      - attach_workspace:
          at: ~/repo
      - restore_cache:
          name: Restore Cached Dependencies
          keys:
            - v1-deps-{{ checksum "package-lock.json" }}
      - run:
          name: Install Dependencies
          command: npm ci
      - run:
          name: Build Bot Application
          command: |
            if grep -q '"project": "bot"' affected.json; then
              npx nx build bot
            else
              echo "Bot not affected. Skipping build."
              exit 0
            fi
      - gcp-gcr/gcr-auth
      - gcp-gcr/build-image:
          image: bot
          dockerfile: packages/bot/Dockerfile
          extra_build_args: --build-arg SHA1=$CIRCLE_SHA1 --build-arg APP=bot
          tag: $CIRCLE_SHA1
      - gcp-gcr/push-image:
          image: bot
          tag: $CIRCLE_SHA1
      - gcp-gcr/tag-image:
          image: bot
          source-tag: $CIRCLE_SHA1
          target-tag: latest

workflows:
  build-and-deploy:
    jobs:
      - detect-affected
      - build-and-push-backend:
          requires:
            - detect-affected
      - build-and-push-bot:
          requires:
            - detect-affected
