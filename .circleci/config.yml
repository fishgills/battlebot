version: 2.1
orbs:
  aws-ecr: circleci/aws-ecr@8.1.2
  aws-ecs: circleci/aws-ecs@3.0.0

parameters:
  # This parameter is used to trigger the main workflow
  trigger:
    type: boolean
    default: false

  # A parameter per package
  backend:
    type: boolean
    default: true
  bot:
    type: boolean
    default: true
  web:
    type: boolean
    default: true

# executors:
#   node:
#     docker:
#       - image: cimg/node:lts

jobs:
  trigger-workflows:
    # executor: node
    steps:
      - checkout
      - run:
          name: Trigger workflows
          command: chmod +x .circleci/circle_trigger.sh && .circleci/circle_trigger.sh
  build:
    parameters:
      package_name:
        type: string
    # machine:
    #   image: ubuntu-2204:2022.04.2 # recommended linux image
    # resource_class: medium
    working_directory: ~/project/

    steps:
      - checkout:
          path: ~/project
      - aws-ecr/build-and-push-image:
          repo: 'mediator-<< parameters.package_name >>'
          dockerfile: packages/<< parameters.package_name >>/Dockerfile
          remote-docker-layer-caching: true
          checkout: false
          platform: linux/arm64
          extra-build-args: --build-arg SHA1=${CIRCLE_SHA1}
          create-repo: false
          tag: '${CIRCLE_SHA1},latest'
          # tag: '${CIRCLE_SHA1},$(echo $CIRCLE_BRANCH | sed -e "s/[^a-zA-Z]/\-/g")'

  deploy:
    parameters:
      package_name:
        type: string
    machine:
      image: ubuntu-2204:2022.04.2 # recommended linux image
    resource_class: medium
    working_directory: ~/project/packages/<< parameters.package_name >>
    steps:
      - checkout:
          path: ~/project
      - aws-ecs/update-service:
          family: 'mediator-<< parameters.package_name >>'
          cluster: 'mediator-cluster'
          service-name: '<< parameters.package_name >>-Service'
          container-image-name-updates: 'container=<< parameters.package_name >>,tag=${CIRCLE_SHA1}'
          # container-env-var-updates: 'container=<< parameters.package_name >>,name=DD_VERSION,value=${CIRCLE_SHA1}'

workflows:
  version: 2

  # The main workflow responsible for triggering all other workflows
  # in which changes are detected.
  ci:
    when: << pipeline.parameters.trigger >>
    jobs:
      - trigger-workflows

  # Workflows defined for each package.

  web:
    when: << pipeline.parameters.web >>
    jobs:
      - build:
          name: web-build
          package_name: web
          context: EnvVariables
      - deploy:
          filters:
            branches:
              only:
                - master
          name: web-deploy
          context: EnvVariables
          package_name: web
          requires:
            - web-build
  backend:
    when: << pipeline.parameters.backend >>
    jobs:
      - build:
          name: backend-build
          package_name: backend
          context: EnvVariables
      - deploy:
          filters:
            branches:
              only:
                - master
          name: backend-deploy
          context: EnvVariables
          package_name: backend
          requires:
            - backend-build
  bot:
    when: << pipeline.parameters.bot >>
    jobs:
      - build:
          name: bot-build
          package_name: bot
          context: EnvVariables
      - deploy:
          filters:
            branches:
              only:
                - master
          name: bot-deploy
          context: EnvVariables
          package_name: bot
          requires:
            - bot-build
